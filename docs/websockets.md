# WebSockets

当使用`WebSocket`技术时, 它包括服务器和客户端两个部分. 服务器部分的详细实现, 请参阅相关[文档](https://github.com/sun1638650145/bunnyburrow-watch2gether-backend/blob/master/docs/websockets.md). 由于我们采用了<b>透明传输</b>的设计理念, 客户端只需要维护好其内部数据格式即可.

因此, 下文重点介绍客户端内部数据的格式.

## 数据格式

客户端有`3`种数据格式: `chat`, `connect`和`player`, 通过`action`属性进行区分.

以下是一个数据包示例.

```javascript
data: {
    // 操作类型: 管理WebSocket连接状态.
    action: 'connect'
    // 数据格式版本: 采用语义化版本规范, 用于识别不同客户端之间数据格式是否兼容, 当前字段缺省为1.0.
    version: '1.1'
    // 其他属性字段: 根据具体操作类型, 提供相关的数据.
}
```

请注意, 不同操作类型可能有特性的属性字段来支持相应的功能.

### chat

`chat`操作用于处理聊天消息.

```javascript
data: {
    action: 'chat'
    // 聊天消息字段.
    message: 'Hello, World!'
    // 用户信息字段.
    user: {
        clientID: 2023 // 只发送客户端ID以减小网络开销.
    }
    version: '1.1'
}
```

### connect

`connect`操作用于管理`WebSocket`连接状态, 包括登录, 确认(回应), 登出, 以及在数据格式版本`1.1`中新增的请求状态. 目前, Web客户端使用数据格式版本`1.0`, iOS客户端则使用版本`1.1`. 在当前的代码实现中, 版本`1.1`向下兼容版本`1.0`, 但在未来升级Web客户端至`1.1`后, 将移除对旧版本的兼容支持.

#### 完整握手流程`1.0` 🤝

|      状态      |                  用户A                   |                            用户B                             |
| :------------: | :--------------------------------------: | :----------------------------------------------------------: |
|                |                                          |                   在用户A登录前已完成登录.                   |
|   用户A登录.   | 登录状态`login`, 广播自己完整的用户信息. |                                                              |
|                |                                          | 添加用户A为好友并回应状态`ack`单播自己完整的用户信息给用户A. |
|                |             添加用户B为好友.             |                                                              |
|                |                   ...                    |                             ...                              |
|   用户A登出.   |  登出状态`logout`, 广播自己的客户端ID.   |                                                              |
|                |                                          |                        标记用户A离线.                        |
|                |                   ...                    |                             ...                              |
| 用户A再次登录. | 登录状态`login`, 广播自己完整的用户信息. | 添加用户A为好友并回应状态`ack`单播自己完整的用户信息给用户A. |

#### 完整握手流程`1.1` 🤝

基于新的数据格式`1.1`, 握手过程中可以复用上次的登录信息, 从而减少网络开销.

|     状态      |                            用户A                             |                            用户B                             |                             备注                             |
| :-----------: | :----------------------------------------------------------: | :----------------------------------------------------------: | :----------------------------------------------------------: |
|               |                                                              |                   在用户A登录前已完成登录.                   |                                                              |
|  用户A登录.   |             登录状态`login`, 广播自己的客户端ID.             |                                                              |                                                              |
|               |                                                              | 判断是否存在此好友(没有用户A的用户信息): 回应状态`request`向用户A单播请求完整的用户信息, 回应状态`ack`单播自己完整的用户信息给用户A. |             使用状态`request`请求用户的完整信息.             |
|               | 回应状态`ack`单播自己完整的用户信息给用户B, 同时添加用户B为好友. |                                                              |                                                              |
|               |                                                              |                       添加用户A为好友.                       |                                                              |
|               |                             ...                              |                             ...                              |                                                              |
|  用户A登出.   |            登出状态`logout`, 广播自己的客户端ID.             |                                                              |                                                              |
|               |                                                              |                        标记用户A离线.                        |                                                              |
|               |                             ...                              |                             ...                              |                                                              |
| 用户A再次登录 |             登录状态`login`, 广播自己的客户端ID.             | 判断是否存在此好友(有用户A的用户信息): 更新用户A的在线状态, 回应状态`ack`单播自己的客户端ID给用户A. | 只广播自己的客户端ID, 之间建立好友关系的客户端不需要再额外接受一份完整用户信息, 减小网络开销. |

#### 登录

用户A登录时需要广播自己的用户信息.

```javascript
data: {
    action: 'connect'
    // 状态字段.
    status: 'login'      // 登录.
    // 用户信息字段.
    user: {
        avatar: 'base64' // 头像的Base64编码字符串.
        clientID: 2023   // 客户端ID.
        name: 'A'        // 昵称.
    }
    version: '1.1'
}
```

#### 确认(回应)

用户B收到用户A的用户信息后, 需要单播自己的用户信息确认并回应.

```javascript
data: {
    action: 'connect'
    status: 'ack' // 确认(回应).
    user: {
        avatar: 'base64'
        clientID: 2024
        name: 'B'
    }
    version: '1.1'
}
```

#### 登出

用户A登出前需要广播自己的用户信息.

```javascript
data: {
    action: 'connect'  
    status: 'logout'   // 登出.  
    user: {
        clientID: 2023 // 只发送客户端ID以减小网络开销.
    }
    version: '1.1'
}
```

#### 请求

用户B单播请求用户A的完整用户信息.

```javascript
data: {
    action: 'connect'
    status: 'request' // 请求.
    version: '1.1'
}
```

### player

`player`操作用于同步视频播放状态, 包括控制视频的播放/暂停, 修改播放进度和调整播放速率.

#### 播放

用户A广播播放视频.

```javascript
data: {
    action: 'player'
    // 命令字段.
    command: 'play'    // 播放.
    // 用户信息字段.
    user: {
        clientID: 2023 // 只发送客户端ID以减小网络开销.
    }
    version: '1.1'
}
```

#### 暂停

用户A广播暂停视频.

```javascript
data: {
    action: 'player'
    command: 'pause' // 暂停.
    user: {
        clientID: 2023
    }
    version: '1.1'
}
```

#### 修改播放进度

用户A广播修改播放进度.

```javascript
data: {
    action: 'player'
    command: {
        newProgress: 117.2024 // 新的播放进度时间(单位为秒).
    }
    user: {
        clientID: 2023
    }
    version: '1.1'
}
```

#### 调整播放速率

用户A广播调整播放速率.

```javascript
data: {
    action: 'player'
    command: {
        playbackRate: 1.5 // 新的播放速率(可选值: 0.5, 0.75, 1, 1.25, 1.5, 2).
    }
    user: {
        clientID: 2023
    }
    version: '1.1'
}
```
